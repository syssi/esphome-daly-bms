interval:
  - interval: 10s
    then:
      # Request: 0xD2 0x03 0x00 0x00 0x00 0x3E 0xD7 0xB9

      - logger.log:
          level: INFO
          format: "--- Expected alarm --> No alarms"
      - lambda: |-
          id(bms0).on_daly_bms_ble_data({
            0xD2, 0x03, 0x7C, 0x0D, 0x6E, 0x0D, 0x69, 0x0D, 0x59, 0x0D,
            0xD7, 0x0D, 0x0B, 0x0D, 0x0B, 0x0D, 0x0C, 0x0D, 0x0B, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3D, 0x00,
            0x28, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x0F, 0x75, 0x30, 0x03, 0xE8, 0x0D,
            0xD7, 0x0D, 0x0B, 0x00, 0x3D, 0x00, 0x3D, 0x00, 0x00, 0x00,
            0xFA, 0x00, 0x08, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x01, 0x0D, 0x46, 0x00, 0xCC, 0x00, 0x00,

            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,

            0x0E, 0xE1
          });

      - delay: 1s
      - logger.log:
          level: INFO
          format: "---\n\n"

      # Register 0x3A, Byte 1, Bit 0: level 1 alarm - charging temperature too high
      - logger.log:
          level: INFO
          format: "--- Expected alarm --> Warning: Charging temperature too high"
      - lambda: |-
          id(bms0).on_daly_bms_ble_data({
            0xD2, 0x03, 0x7C, 0x0D, 0x6E, 0x0D, 0x69, 0x0D, 0x59, 0x0D,
            0xD7, 0x0D, 0x0B, 0x0D, 0x0B, 0x0D, 0x0C, 0x0D, 0x0B, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3D, 0x00,
            0x28, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x0F, 0x75, 0x30, 0x03, 0xE8, 0x0D,
            0xD7, 0x0D, 0x0B, 0x00, 0x3D, 0x00, 0x3D, 0x00, 0x00, 0x00,
            0xFA, 0x00, 0x08, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x01, 0x0D, 0x46, 0x00, 0xCC, 0x00, 0x00,

            0x01,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,

            0xCF, 0x2D
          });

      - delay: 1s
      - logger.log:
          level: INFO
          format: "---\n\n"

      # Register 0x3A, Byte 0, Bit 0: level 1 alarm - cell voltage too high
      - logger.log:
          level: INFO
          format: "--- Expected alarm --> Warning: Cell voltage too high"
      - lambda: |-
          id(bms0).on_daly_bms_ble_data({
            0xD2, 0x03, 0x7C, 0x0D, 0x6E, 0x0D, 0x69, 0x0D, 0x59, 0x0D,
            0xD7, 0x0D, 0x0B, 0x0D, 0x0B, 0x0D, 0x0C, 0x0D, 0x0B, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3D, 0x00,
            0x28, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x0F, 0x75, 0x30, 0x03, 0xE8, 0x0D,
            0xD7, 0x0D, 0x0B, 0x00, 0x3D, 0x00, 0x3D, 0x00, 0x00, 0x00,
            0xFA, 0x00, 0x08, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x01, 0x0D, 0x46, 0x00, 0xCC, 0x00, 0x00,

            0x00,
            0x01,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,

            0x1E, 0x21
          });

      - delay: 1s
      - logger.log:
          level: INFO
          format: "---\n\n"

      # Register 0x3B, Byte 1, Bit 0: level 1 alarm - voltage difference too high
      - logger.log:
          level: INFO
          format: "--- Expected alarm --> Warning: Voltage difference too high"
      - lambda: |-
          id(bms0).on_daly_bms_ble_data({
            0xD2, 0x03, 0x7C, 0x0D, 0x6E, 0x0D, 0x69, 0x0D, 0x59, 0x0D,
            0xD7, 0x0D, 0x0B, 0x0D, 0x0B, 0x0D, 0x0C, 0x0D, 0x0B, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3D, 0x00,
            0x28, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x0F, 0x75, 0x30, 0x03, 0xE8, 0x0D,
            0xD7, 0x0D, 0x0B, 0x00, 0x3D, 0x00, 0x3D, 0x00, 0x00, 0x00,
            0xFA, 0x00, 0x08, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x01, 0x0D, 0x46, 0x00, 0xCC, 0x00, 0x00,

            0x00,
            0x00,
            0x01,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,

            0x0F, 0x30
          });

      - delay: 1s
      - logger.log:
          level: INFO
          format: "---\n\n"

      # Register 0x3B, Byte 0, Bit 0: level 1 alarm - charging current too high
      - logger.log:
          level: INFO
          format: "--- Expected alarm --> Warning: Charging current too high"
      - lambda: |-
          id(bms0).on_daly_bms_ble_data({
            0xD2, 0x03, 0x7C, 0x0D, 0x6E, 0x0D, 0x69, 0x0D, 0x59, 0x0D,
            0xD7, 0x0D, 0x0B, 0x0D, 0x0B, 0x0D, 0x0C, 0x0D, 0x0B, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3D, 0x00,
            0x28, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x0F, 0x75, 0x30, 0x03, 0xE8, 0x0D,
            0xD7, 0x0D, 0x0B, 0x00, 0x3D, 0x00, 0x3D, 0x00, 0x00, 0x00,
            0xFA, 0x00, 0x08, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x01, 0x0D, 0x46, 0x00, 0xCC, 0x00, 0x00,

            0x00,
            0x00,
            0x00,
            0x01,
            0x00,
            0x00,
            0x00,
            0x00,

            0x33, 0x21
          });

      - delay: 1s
      - logger.log:
          level: INFO
          format: "---\n\n"

      # Register 0x3C, Byte 1, Bit 0: AFE acquisition chip failure
      - logger.log:
          level: INFO
          format: "--- Expected alarm --> AFE acquisition chip failure"
      - lambda: |-
          id(bms0).on_daly_bms_ble_data({
            0xD2, 0x03, 0x7C, 0x0D, 0x6E, 0x0D, 0x69, 0x0D, 0x59, 0x0D,
            0xD7, 0x0D, 0x0B, 0x0D, 0x0B, 0x0D, 0x0C, 0x0D, 0x0B, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3D, 0x00,
            0x28, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x0F, 0x75, 0x30, 0x03, 0xE8, 0x0D,
            0xD7, 0x0D, 0x0B, 0x00, 0x3D, 0x00, 0x3D, 0x00, 0x00, 0x00,
            0xFA, 0x00, 0x08, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x01, 0x0D, 0x46, 0x00, 0xCC, 0x00, 0x00,

            0x00,
            0x00,
            0x00,
            0x00,
            0x01,
            0x00,
            0x00,
            0x00,

            0x0F, 0x1D
          });

      - delay: 1s
      - logger.log:
          level: INFO
          format: "---\n\n"

      # Register 0x3C, Byte 0, Bit 0: charging MOS over-temperature warning
      - logger.log:
          level: INFO
          format: "--- Expected alarm --> Charging MOS over-temperature warning"
      - lambda: |-
          id(bms0).on_daly_bms_ble_data({
            0xD2, 0x03, 0x7C, 0x0D, 0x6E, 0x0D, 0x69, 0x0D, 0x59, 0x0D,
            0xD7, 0x0D, 0x0B, 0x0D, 0x0B, 0x0D, 0x0C, 0x0D, 0x0B, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3D, 0x00,
            0x28, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x0F, 0x75, 0x30, 0x03, 0xE8, 0x0D,
            0xD7, 0x0D, 0x0B, 0x00, 0x3D, 0x00, 0x3D, 0x00, 0x00, 0x00,
            0xFA, 0x00, 0x08, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x01, 0x0D, 0x46, 0x00, 0xCC, 0x00, 0x00,

            0x00,
            0x00,
            0x00,
            0x00,
            0x00,
            0x01,
            0x00,
            0x00,

            0x5F, 0x21
          });

      - delay: 1s
      - logger.log:
          level: INFO
          format: "---\n\n"

      # https://github.com/syssi/esphome-daly-bms/pull/20#issuecomment-2558515723
      - logger.log:
          level: INFO
          format: "--- Expected alarm --> Critical: Temperature difference too high"
      - lambda: |-
          id(bms0).on_daly_bms_ble_data({
            0xD2, 0x03, 0x7C, 0x0D, 0x6E, 0x0D, 0x69, 0x0D, 0x59, 0x0D,
            0xD7, 0x0D, 0x0B, 0x0D, 0x0B, 0x0D, 0x0C, 0x0D, 0x0B, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3D, 0x00,
            0x28, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x0F, 0x75, 0x30, 0x03, 0xE8, 0x0D,
            0xD7, 0x0D, 0x0B, 0x00, 0x3D, 0x00, 0x3D, 0x00, 0x00, 0x00,
            0xFA, 0x00, 0x08, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x01, 0x0D, 0x46, 0x00, 0xCC, 0x00, 0x00,

            0x00,
            0x00,
            0x08,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,

            0x0F, 0xA9
          });

      - delay: 1s
      - logger.log:
          level: INFO
          format: "---\n\n"

      - logger.log:
          level: INFO
          format: "--- Expected alarm --> Warning: Temperature difference too high;Critical: Temperature difference too high"
      - lambda: |-
          id(bms0).on_daly_bms_ble_data({
            0xD2, 0x03, 0x7C, 0x0D, 0x6E, 0x0D, 0x69, 0x0D, 0x59, 0x0D,
            0xD7, 0x0D, 0x0B, 0x0D, 0x0B, 0x0D, 0x0C, 0x0D, 0x0B, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3D, 0x00,
            0x28, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x0F, 0x75, 0x30, 0x03, 0xE8, 0x0D,
            0xD7, 0x0D, 0x0B, 0x00, 0x3D, 0x00, 0x3D, 0x00, 0x00, 0x00,
            0xFA, 0x00, 0x08, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x01, 0x0D, 0x46, 0x00, 0xCC, 0x00, 0x00,

            0x00,
            0x00,
            0x0C,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,

            0x0E, 0x2D
          });

      - delay: 1s
      - logger.log:
          level: INFO
          format: "---\n\n"

      - logger.log:
          level: INFO
          format: "--- Expected alarm --> Warning: Temperature difference too high"
      - lambda: |-
          id(bms0).on_daly_bms_ble_data({
            0xD2, 0x03, 0x7C, 0x0D, 0x6E, 0x0D, 0x69, 0x0D, 0x59, 0x0D,
            0xD7, 0x0D, 0x0B, 0x0D, 0x0B, 0x0D, 0x0C, 0x0D, 0x0B, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3D, 0x00,
            0x28, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x0F, 0x75, 0x30, 0x03, 0xE8, 0x0D,
            0xD7, 0x0D, 0x0B, 0x00, 0x3D, 0x00, 0x3D, 0x00, 0x00, 0x00,
            0xFA, 0x00, 0x08, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x01, 0x0D, 0x46, 0x00, 0xCC, 0x00, 0x00,

            0x00,
            0x00,
            0x04,
            0x00,
            0x00,
            0x00,
            0x00,
            0x00,

            0x0F, 0x65
          });

      - delay: 1s
      - logger.log:
          level: INFO
          format: "---\n\n"


substitutions:
  name: daly-bms-ble
  device_description: "Monitor a DALY Battery Management System via BLE"
  external_components_source: github://syssi/esphome-daly-bms@main
  mac_address: !secret bms0_mac_address

esphome:
  name: ${name}
  comment: ${device_description}
  min_version: 2024.6.0
  project:
    name: "syssi.esphome-daly-bms"
    version: 1.0.0

esp32:
  board: wemos_d1_mini32
  framework:
    type: esp-idf

external_components:
  - source: ${external_components_source}
    refresh: 0s

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

ota:
  platform: esphome

logger:
  level: DEBUG

api:
  reboot_timeout: 0s

esp32_ble_tracker:
  scan_parameters:
    active: false

ble_client:
  - mac_address: ${mac_address}
    id: client0

daly_bms_ble:
  - ble_client_id: client0
    id: bms0
    update_interval: 10s

sensor:
  - platform: daly_bms_ble
    daly_bms_ble_id: bms0
    error_bitmask:
      name: "${name} error bitmask"

text_sensor:
  - platform: daly_bms_ble
    daly_bms_ble_id: bms0
    errors:
      name: "${name} errors"
